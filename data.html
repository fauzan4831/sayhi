<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SayHi! ‚Äì Data Tamu</title>

  <!-- === HEAD TEMPLATE GLOBAL === -->
  <link rel="icon" href="gambar/logo.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="css/sayhi-theme.css">
  <link rel="stylesheet" href="css/app.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .left-tools {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .aksi {
      width: 56px;
      text-align: center;
    }

    .btn-icon {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 6px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      filter: brightness(.96);
    }

    /* === FIX KONFLIK BOOTSTRAP: GANTI NAMA CLASS === */
    .confirm-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .confirm-box {
      width: min(420px, 92vw);
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, .15);
      border: 1px solid #ffd6db;
      text-align: left;
      z-index: 10000;
    }

    .confirm-box h3 {
      margin: 0 0 6px;
      color: #e85c5c;
    }

    .confirm-box p {
      margin: 0 0 14px;
      color: #555;
    }

    .confirm-box .row {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-danger {
      background: #ffd6db;
    }

    .btn-ghost {
      background: #eee;
    }

    .pagination .page.active {
      background: #ffd6db;
      border-color: #ffd6db;
    }

    .viewer-mode .btn-delete,
    .viewer-mode [data-del] {
      display: none !important;
    }
  </style>

  <!-- === PROTEKSI LOGIN & ROLE === -->
  <script>
    (async function guardPage() {
      try {
        const r = await fetch("/sayhi/api/auth/me.php");
        const s = await r.json();

        if (!s.loggedIn) {
          location.href = "login.html";
          return;
        }

        const adminOnly = ["data.html", "laporan.html", "akun.html"];
        const current = location.pathname.split("/").pop();
        if (adminOnly.includes(current) && s.role !== "Admin") {
          alert("Halaman ini hanya untuk Admin.");
          location.href = "index.html";
          return;
        }

        if (s.role !== "Admin") {
          document.body.classList.add("viewer-mode");
        }
      } catch (e) {
        location.href = "login.html";
      }
    })();
  </script>
</head>

<body>
  <div id="sayhi-navbar"></div>
  <div id="topbar"></div>

  <main class="container my-4">
    <div class="card p-3">
      <div class="topbar">
        <div class="left-tools">
          <input type="text" class="input form-control" id="search" placeholder="üîç Cari nama / instansi..." />
        </div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>ID_TAMU</th>
            <th>NAMA</th>
            <th>INSTANSI</th>
            <th>NO TELPON</th>
            <th>EMAIL</th>
            <th>TANGGAL</th>
            <th class="aksi">Aksi</th>
          </tr>
        </thead>
        <tbody id="tblBody"></tbody>
      </table>

      <div class="pagination" id="pager"></div>
    </div>
  </main>

  <!-- === GANTI NAMA CLASS MODAL === -->
  <div class="confirm-backdrop" id="confirmBackdrop" aria-hidden="true">
    <div class="confirm-box" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">Hapus data tamu?</h3>
      <p>Data akan dihapus permanen. Yakin ingin melanjutkan?</p>
      <div class="row">
        <button class="btn btn-ghost" id="btnCancel">Batal</button>
        <button class="btn btn-danger" id="btnYes">Hapus</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="javascript/script.js"></script>

  <script>
    // === FUNGSI TOAST NOTIFIKASI ===
    function SayHiToast(message, type = "info") {
      Swal.fire({
        toast: true,
        position: "top-end",
        icon: type,
        title: message,
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
      });
    }

    const tbody = document.getElementById('tblBody');
    const pager = document.getElementById('pager');
    const searchInput = document.getElementById('search');
    let page = 1, totalPage = 1, q = '', pendingDeleteId = null;

    async function loadData() {
      const url = `/sayhi/api/tamu/list.php?search=${encodeURIComponent(q)}&page=${page}`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        if (json.status !== 'success') {
          tbody.innerHTML = `<tr><td colspan="7">Gagal memuat data.</td></tr>`;
          pager.innerHTML = ''; return;
        }

        const rows = json.data.map(t => `
          <tr>
            <td>${t.id_tamu}</td>
            <td>${t.nama}</td>
            <td>${t.instansi}</td>
            <td>${t.no_hp}</td>
            <td>${t.email}</td>
            <td>${t.tanggal}</td>
            <td class="aksi">
              <button class="btn-icon btn-delete" title="Hapus" data-del="${t.id_tamu}">üóëÔ∏è</button>
            </td>
          </tr>`).join('');

        tbody.innerHTML = rows || `<tr><td colspan="7">Tidak ada data.</td></tr>`;
        totalPage = json.totalPage || 1;
        renderPager();
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="7">Gagal memuat data (koneksi bermasalah).</td></tr>`;
        pager.innerHTML = '';
      }
    }

    function renderPager() {
      const pages = Math.max(1, totalPage);
      const items = [];
      items.push(`<button class="page" ${page === 1 ? 'disabled' : ''} onclick="gotoPage(${page - 1})">‚óÄ</button>`);
      const windowSize = 5;
      let start = Math.max(1, page - Math.floor(windowSize / 2));
      let end = Math.min(pages, start + windowSize - 1);
      if (end - start + 1 < windowSize) start = Math.max(1, end - windowSize + 1);
      for (let i = start; i <= end; i++) {
        items.push(`<button class="page ${i === page ? 'active' : ''}" onclick="gotoPage(${i})">${i}</button>`);
      }
      items.push(`<button class="page" ${page === pages ? 'disabled' : ''} onclick="gotoPage(${page + 1})">‚ñ∂</button>`);
      pager.innerHTML = items.join('');
    }

    window.gotoPage = function (n) { if (n < 1 || n > totalPage) return; page = n; loadData(); };

    let _t;
    searchInput.addEventListener('input', () => {
      clearTimeout(_t);
      _t = setTimeout(() => {
        q = searchInput.value.trim(); page = 1; loadData();
      }, 300);
    });

    const backdrop = document.getElementById('confirmBackdrop');
    const btnCancel = document.getElementById('btnCancel');
    const btnYes = document.getElementById('btnYes');

    function openConfirm(id) {
      pendingDeleteId = id;
      backdrop.style.display = 'flex';
      backdrop.setAttribute('aria-hidden', 'false');
    }

    function closeConfirm() {
      pendingDeleteId = null;
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden', 'true');
    }

    backdrop.addEventListener('click', e => {
      if (e.target === backdrop) closeConfirm();
    });

    tbody.addEventListener('click', e => {
      const btn = e.target.closest('[data-del]');
      if (!btn || document.body.classList.contains('viewer-mode')) return;
      const id = Number(btn.getAttribute('data-del'));
      openConfirm(id);
    });

    btnCancel.addEventListener('click', closeConfirm);

    // === HANDLER HAPUS DENGAN CREDENTIALS DAN LOG ===
    btnYes.addEventListener('click', async () => {
      if (!pendingDeleteId) return;
      try {
        const res = await fetch(`/sayhi/api/tamu/delete.php?id=${pendingDeleteId}`, {
          method: "GET",
          credentials: "include"
        });
        const json = await res.json();
        console.log(json);

        if (json.status === 'success') {
          closeConfirm();
          await loadData();
          SayHiToast("Data berhasil dihapus", "success");
        } else {
          SayHiToast(json.message || "Gagal menghapus data", "error");
          closeConfirm();
        }
      } catch (err) {
        SayHiToast("Koneksi gagal", "error");
        console.error(err);
      }
    });

    loadData();
  </script>
</body>

</html>