<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SayHi! â€“ Laporan</title>

  <link rel="icon" href="gambar/logo.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="css/sayhi-theme.css">
  <link rel="stylesheet" href="css/app.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    (async function guardPage() {
      try {
        const r = await fetch("/sayhi/api/auth/me.php");
        const s = await r.json();
        if (!s.loggedIn) { location.href = "login.html"; return; }
        const adminOnly = ["data.html", "laporan.html", "akun.html"];
        const current = location.pathname.split("/").pop();
        if (adminOnly.includes(current) && s.role !== "Admin") {
          alert("Halaman ini hanya untuk Admin.");
          location.href = "index.html";
        }
      } catch { location.href = "login.html"; }
    })();
  </script>
</head>

<body>
  <div id="sayhi-navbar"></div>
  <div id="topbar"></div>

  <main class="container my-4">
    <!-- === TABEL LAPORAN TAMU === -->
    <div class="card shadow-sm p-3 mt-4" style="border-radius:18px;">
      <h3 class="fw-bold mb-3">Daftar Tamu</h3>

      <!-- FILTER TANGGAL + EKSPOR -->
      <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
        <div>
          <label class="form-label mb-1">Dari Tanggal</label>
          <input type="date" id="tglAwal" class="form-control form-control-sm">
        </div>
        <div>
          <label class="form-label mb-1">Sampai Tanggal</label>
          <input type="date" id="tglAkhir" class="form-control form-control-sm">
        </div>
        <button class="btn btn-primary btn-sm" id="btnFilter">Tampilkan</button>
        <button class="btn btn-success btn-sm" id="btnExport">Ekspor CSV</button>
      </div>

      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>Nama</th>
              <th>Instansi</th>
              <th>Email</th>
              <th>Status</th>
              <th>Tanggal</th>
            </tr>
          </thead>
          <tbody id="laporanTable"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="javascript/script.js"></script>

  <!-- === LAPORAN + FILTER + EKSPOR === -->
  <script>
    async function loadLaporan(tglAwal = "", tglAkhir = "") {
      try {
        let url = "/sayhi/api/tamu/list.php";
        if (tglAwal && tglAkhir) url += `?awal=${tglAwal}&akhir=${tglAkhir}`;

        const res = await fetch(url);
        const j = await res.json();
        const tb = document.getElementById("laporanTable");
        tb.innerHTML = "";

        if (j.status !== "success" || !Array.isArray(j.data)) {
          tb.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tidak ada data.</td></tr>`;
          return;
        }

        for (const t of j.data) {
          tb.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${t.nama}</td>
              <td>${t.instansi}</td>
              <td>${t.email}</td>
              <td>${t.status}</td>
              <td>${t.tanggal}</td>
            </tr>`);
        }
      } catch (e) { console.error(e); }
    }

    document.getElementById("btnFilter").addEventListener("click", () => {
      const a = document.getElementById("tglAwal").value;
      const b = document.getElementById("tglAkhir").value;
      loadLaporan(a, b);
    });

    function exportTableToCSV(filename = "laporan_tamu.csv") {
      const rows = document.querySelectorAll("#laporanTable tr");
      if (!rows.length) return;
      let csv = "Nama,Instansi,Email,Status,Tanggal\n";
      rows.forEach(r => {
        const cols = r.querySelectorAll("td");
        const data = Array.from(cols).map(td => `"${td.innerText}"`).join(",");
        csv += data + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById("btnExport").addEventListener("click", () => exportTableToCSV());
    document.addEventListener("DOMContentLoaded", () => loadLaporan());
  </script>
</body>

</html>