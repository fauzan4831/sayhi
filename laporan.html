<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SayHi! – Laporan</title>

  <!-- === HEAD TEMPLATE GLOBAL === -->
  <link rel="icon" href="gambar/logo.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="css/sayhi-theme.css">
  <link rel="stylesheet" href="css/app.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    (async function guard() {
      try {
        const r = await fetch("/sayhi/api/auth/me.php");
        const s = await r.json();
        if (!s.loggedIn) { location.href = "login.html"; }
      } catch (e) { location.href = "login.html"; }
    })();
  </script>
</head>

<body>
  <!-- === NAVBAR GLOBAL PLACEHOLDER === -->
  <div id="sayhi-navbar"></div>
  <div id="topbar"></div>

  <!-- === MAIN CONTENT === -->
  <main class="container my-4">
    <!-- Stats -->
    <div class="grid stats mb-4">
      <div class="card stat p-3 text-center shadow-sm">
        <h3>Hari ini</h3>
        <div class="val fs-4 fw-bold" id="sToday">32</div>
      </div>
      <div class="card stat p-3 text-center shadow-sm">
        <h3>Bulan ini</h3>
        <div class="val fs-4 fw-bold" id="sMonth">420</div>
      </div>
      <div class="card stat p-3 text-center shadow-sm">
        <h3>Total Tamu</h3>
        <div class="val fs-4 fw-bold" id="sTotal">1,234</div>
      </div>
    </div>

    <div class="card p-3 shadow-sm">
      <!-- Toolbar -->
      <div class="toolbar d-flex flex-wrap gap-2 mb-3">
        <input type="date" class="form-control" id="from" style="max-width:160px">
        <input type="date" class="form-control" id="to" style="max-width:160px">
        <input type="text" class="form-control flex-grow-1" id="q" placeholder="Cari nama / instansi">
        <button class="btn btn-primary" id="btnFilter">Filter</button>
        <button class="btn btn-secondary" id="btnReset">Reset</button>
        <button class="btn btn-outline-success" id="btnCsv">Export CSV</button>
      </div>

      <div class="table-responsive">
        <table class="table align-middle" id="tbl">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Nama</th>
              <th>Instansi</th>
              <th>Masuk</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="pagination mt-3 text-center" id="pager"></div>
    </div>
  </main>

  <!-- === SCRIPTS === -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="javascript/script.js"></script>

  <script>
    // ====== CONTOH DATA ======
    const data = [
      { nama: "Rani Putri", instansi: "PT ABC", masuk: "2025-09-28 08:10" },
      { nama: "Budi", instansi: "UMSU", masuk: "2025-09-28 08:35" },
      { nama: "Tasya", instansi: "PT Daya", masuk: "2025-09-28 09:10" },
      { nama: "Sinta", instansi: "Politeknik", masuk: "2025-09-28 10:00" },
    ];
    while (data.length < 35)
      data.push({ ...data[data.length % 4], nama: (data.length % 2 ? "Guest " : "Tamu ") + (data.length + 1) });

    const tbody = document.getElementById('tbody');
    const pager = document.getElementById('pager');
    let view = [...data], page = 1, per = 10;

    function render() {
      const s = (page - 1) * per, e = s + per;
      tbody.innerHTML = view.slice(s, e).map((d, i) => `
        <tr>
          <td>${s + i + 1}</td>
          <td>${d.nama}</td>
          <td>${d.instansi}</td>
          <td>${d.masuk}</td>
        </tr>`).join('');

      const pages = Math.max(1, Math.ceil(view.length / per));
      pager.innerHTML = `
        <button class="page" ${page === 1 ? 'disabled' : ''} onclick="page=1;render()">«</button>
        <button class="page" ${page === 1 ? 'disabled' : ''} onclick="page=Math.max(1,page-1);render()">Prev</button>
        ${Array.from({ length: pages }, (_, i) => `<button class="page ${i + 1 === page ? 'active' : ''}" onclick="page=${i + 1};render()">${i + 1}</button>`).join('')}
        <button class="page" ${page === pages ? 'disabled' : ''} onclick="page=Math.min(${pages},page+1);render()">Next</button>
        <button class="page" ${page === pages ? 'disabled' : ''} onclick="page=${pages};render()">»</button>`;
    }

    function applyFilter() {
      const q = document.getElementById('q').value.toLowerCase().trim();
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      view = data.filter(d => {
        const okText = (d.nama + d.instansi).toLowerCase().includes(q);
        const t = d.masuk.slice(0, 10);
        const okFrom = !from || t >= from;
        const okTo = !to || t <= to;
        return okText && okFrom && okTo;
      });
      page = 1; render();
    }

    function exportCsv() {
      const head = ["No", "Nama", "Instansi", "Masuk"];
      const rows = view.map((d, i) => [i + 1, d.nama, d.instansi, d.masuk]);
      const csv = [head, ...rows]
        .map(r => r.map(x => `"${(x ?? '').toString().replace(/"/g, '""')}"`).join(","))
        .join("\n");

      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
      a.download = 'laporan_sayhi.csv';
      a.click();
    }

    document.getElementById('btnFilter').onclick = applyFilter;
    document.getElementById('btnReset').onclick = () => {
      ['q', 'from', 'to'].forEach(id => document.getElementById(id).value = "");
      view = [...data];
      page = 1;
      render();
    };
    document.getElementById('btnCsv').onclick = exportCsv;

    render();
  </script>
</body>

</html>
